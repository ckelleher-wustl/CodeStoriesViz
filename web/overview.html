<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="css/collapsible.css">
<link rel="stylesheet" href="css/accordion.css">
<link rel="stylesheet" href="css/diff.css">
</head>
<body>
  <script type = "text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script> 
  <script src="node_modules/diff/dist/diff.js"></script>

  <link rel="stylesheet" type="text/css" href="node_modules/diff2html/bundles/css/diff2html.min.css"/>
  <script src="node_modules/diff2html/bundles/js/diff2html.min.js"></script>
  <script src="//unpkg.com/string-similarity/umd/string-similarity.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <!-- <script type = "module" src="/public/javascripts/diff_from_full.js"></script>   -->

  <button onclick="openTab('history')">History</button>
  <button onclick="openTab('code')">Code</button>
  <button onclick="openTab('test')">Test</button>

  <div id="history" class="tab">
    <h2>History Tab</h2>
      <div include-html="clusters_WordleNew.html"></div>

      <button type="button" class="collapsible">THE END</button>
      <div class="content">
        <p>This is the end of the recorded code history.</p>
      </div>
  </div>

  <div id="code" class="tab">
    <h2>script.js</h2>
    <div include-html="code_WordleNew.html"></div>
    <!-- Add content for the code tab here -->
  </div>


  <div id="test" class="tab">
    <h2>testing code</h2>
    <div include-html="test.html"></div>
    <!-- Add content for the code tab here -->
  </div>


  <script type="text/javascript" src="js/youtube.js"></script>
  <script type="text/javascript" src="js/accordion.js"></script>
  <script type="text/javascript" src="js/includehtml.js"></script>
  <script type="text/javascript" src="js/tab.js"></script>


  <script>
    
    // currently trying to figure out how to not have to call the inits anymore.
    $(document).ready(function(){
      includeHTML();
      console.log("calling inits...")
      openTab('history');
      initCollapsibles();
      initHistory();
    });

    function initCollapsibles() {

      var coll = document.getElementsByClassName("collapsible");
      var i;
      
      console.log("adding listeners....")
      for (i = 0; i < coll.length; i++) {
        console.log("adding listener to " + coll[i]);
        coll[i].addEventListener("click", function() {
          this.classList.toggle("active");
          var content = this.nextElementSibling;
          if (content.style.display === "block") {
            content.style.display = "none";
            // console.log("closed")
          } else {
            content.style.display = "block";
            console.log(content)
            // console.log("opened " + content.getAttribute("--start-code") + " to " + content.getAttribute("--end-code"))

            if (content.hasAttribute("--start-code")) {
      
              var diff = Diff.createTwoFilesPatch("begin", "end", content.getAttribute("--start-code"), content.getAttribute("--end-code"),null,null,{context:100});
              console.log("diff is " + typeof(diff) + " " + (diff.split("\n").length))
        
              var addition = "";
              diff.split("\n").forEach(part => {
                if (part.startsWith("+") && !(part.startsWith("+++")) && (part.length > 3) && (addition == "")) {
                  addition = part
                }
                console.log(part.length + " " + part)
              })
              // this.textContent = addition
              var diffHtml = Diff2Html.html(diff, {
                  drawFileList: false,
                  //matching: 'words',
                  outputFormat: 'side-by-side',
              });
              content.querySelector("p").innerHTML = diffHtml;
            }
          }
        });
      }
    }


  function initHistory() {

    var histElems = document.getElementsByClassName("history");
    var i;

    console.log("adding listeners....")
    for (i = 0; i < histElems.length; i++) {
      console.log("adding listener to " + histElems[i]);
      histElems[i].addEventListener("click", function() {
        this.classList.toggle("active");
        console.log("clicking on a history element..." + this.textContent);

        openTab("history");
        openChange(this.textContent, true);      
      });
    }
  }


  function openChange(title, open) {

    var history = $(".history")

    // $(content,$(this).find('p:first')).html(diffHtml);
    
    var button =  $("button.collapsible:contains('" + title + "')")
    var content = button.next()

    // console.log("button is " + button)
    // console.log("content is " + content)
    
    if (!open) {
      content.attr("style", "display:none")
      // console.log("closed")
    } else  {
      content.attr("style", "display:block")
      // console.log(content)


      var diff = Diff.createTwoFilesPatch("begin", "end", content.attr("--start-code"), content.attr("--end-code"),null,null,{context:100});
      console.log("diff is " + typeof(diff) + " " + (diff.split("\n").length))

      var addition = "";
      diff.split("\n").forEach(part => {
        if (part.startsWith("+") && !(part.startsWith("+++")) && (part.length > 3) && (addition == "")) {
          addition = part
        }
        // console.log(part.length + " " + part)
      })
      // this.textContent = addition
      var diffHtml = Diff2Html.html(diff, {
          drawFileList: false,
          //matching: 'words',
          outputFormat: 'side-by-side',
      });
      $(content,$(this).find('p:first')).html(diffHtml);

      // try to scroll this content pane so that it's visible.

      var offset = content.offset().top - $(window).scrollTop();

      if(offset > window.innerHeight){
          // Not in view so scroll to it
          $('html,body').animate({scrollTop: offset}, 1000);
      }  
            }
  }


  </script>
</body>
</html>